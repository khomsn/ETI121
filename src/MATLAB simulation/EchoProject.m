% Echo Projects%% tmr%close allclear allclc% load  input and output signal of hybrid% input signal to hybrid: u% output signal of hybrid: dFs = 44100/4;% disp('Recording');%  Y = wavrecord(5*Fs,Fs,1,'double');%  disp('Stop Recording')%  save 'Salam.mat' 'Y'load Salam.mat;sigma_noise = 0.1;Y = Y(1:4:end);Y = [Y(1:1.5e4); Y];disp('play original voice of A');wavplay(Y,Fs)disp('-----------------');DelayTime0 = floor(0.4 * Fs);Num_Echos =2;Y = [Y;zeros(Num_Echos*DelayTime0,1)];h = randn(50,1);h = h / norm(h); %figure;freqz(h)% Noise = sigma_noise ;EY = filter(h,1,Y) ;DelayTime = 0;for NC = 1:Num_Echos    %Coef= 0.5+rand;    h = randn(50,1);h= h/norm(h);    DelayTime = DelayTime + DelayTime0;    EY(DelayTime:end) = EY(DelayTime:end) + (0.5)^NC * filter(h,1,Y(1:end-DelayTime+1));enddisp('play echo signal from A');wavplay(EY,Fs)disp('-----------------');% th = xcorr(Y,EY);% figure;plot(th)%% NLMS %%%%%%%%%%%%% filter lengthM_nlms=10000;%%%%%%%%%SI = 1:length(Y);% max(1,17e3-M_nlms):48e3;d = EY(SI); d = [d;d];u = Y(SI);u= [u;u];figure;plot(u,'r');hold on; plot(d,'b');legend('Signal u','d:Echos of u')getframe;%%%%%%%%%% step size of NLMSmu_nlms=0.5;% protection constanta=0.01;% run NLMS[e_nlms,w_nlms]=nlms_1(mu_nlms,M_nlms,u,d,a,0);% [e_nlms,w_nlms]=nlms_1(mu_nlms,M_nlms,u,d,a,0,w_nlms);% [e_nlms,w_nlms]=nlms_1(mu_nlms,M_nlms,u,d,a,0,w_nlms);% wavplay( e_nlms(:),Fs)figure;stem(w_nlms);getframe;%plot errorfigure%(1);h1=plot([1:length(d)],d,'.g',[1:length(d)],e_nlms,'r');legend(h1,{'ouput d(n)','residual echo e(n) of NLMS'},0);xlabel('iteration n');ylabel('amplitude');getframe;%% load B_vect.matB_vect = B_vect * 0.4;B_vect = [B_vect(1:1.5e4);B_vect];disp(' B talking');wavplay(B_vect,Fs)disp('-----------------');DoubleTalk = EY;DoubleTalk(1:length(B_vect)) = B_vect + DoubleTalk(1:length(B_vect));disp('Echo Signal + B talking');wavplay(DoubleTalk,Fs);disp('-----------------');u = Y;d = DoubleTalk;% figure;stem(DoubleTalk);% figure;stem(EY);% th0 = xcorr(Y,DoubleTalk);% figure; plot(th0)[e_nlms2,w_nlms2]=nlms_2(mu_nlms,M_nlms,u,d,a,0,w_nlms);figure; hold on; plot(DoubleTalk,'b')plot(e_nlms2,'r');plot(B_vect,'g');legend('B+Echos','remove Echos from B','Signal B')getframe;disp('Remove Echo Signal from B ')wavplay(e_nlms2,Fs)disp('-----------------');